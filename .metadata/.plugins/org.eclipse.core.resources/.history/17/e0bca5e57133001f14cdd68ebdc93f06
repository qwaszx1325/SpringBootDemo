package com.competnion.controller;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.util.LinkedMultiValueMap;
import org.springframework.util.MultiValueMap;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.client.RestTemplate;

import com.competnion.util.StendMail;

@Controller
public class Demo {
	@Autowired
	private StendMail stendMail;

	@GetMapping("/hello")
	public String demo() {
		stendMail.sendSimpleEmail("qwaszx1325@gmail.com", "Test Subject", "This is a test email.");

		return "Hello";
	}
	
	@GetMapping("/pay")
    public String pay(Model model) {
        // 支付參數
        MultiValueMap<String, String> params = new LinkedMultiValueMap<>();
        //商店代號
        params.add("MerchantID", "2000132");
        //商店交易編號
        params.add("MerchantTradeNo", "1234567890");
        //商店交易日期
        params.add("MerchantTradeDate", "2024/05/27 12:34:56");
        //交易類型
        params.add("PaymentType", "aio");
        //交易總金額
        params.add("TotalAmount", "1000");
        //交易描述
        params.add("TradeDesc", "Test transaction");
        //商品名稱
        params.add("ItemName", "Item1#Item2");
        //回傳URL
        params.add("ReturnURL", "https://c24d-61-222-34-1.ngrok-free.app");
        //預設付款方式
        params.add("ChoosePayment", "All");
        //檢查碼(金鑰)
        params.add("CheckMacValue", "6A7A8F08F6BCB08C3B0E60C90B7A8F14");
        //加密類型 1 為MD5加密
        params.add("EncryptType", "1");

        // 將參數添加到 model 中
        model.addAttribute("params", params);

        // 返回支付頁面
        return "pay";
    }

	@PostMapping("/pay")
    public String submitPay(@RequestParam MultiValueMap<String, String> formData, Model model) {
        RestTemplate restTemplate = new RestTemplate();

        HttpHeaders headers = new HttpHeaders();
        headers.setContentType(MediaType.APPLICATION_FORM_URLENCODED);

        HttpEntity<MultiValueMap<String, String>> request = new HttpEntity<>(formData, headers);

        ResponseEntity<String> response = restTemplate.postForEntity(
                "https://payment-stage.ecpay.com.tw/Cashier/AioCheckOut/V5",
                request,
                String.class
        );

        model.addAttribute("response", response.getBody());

        // 返回結果頁面
        return "result";
	}
}
